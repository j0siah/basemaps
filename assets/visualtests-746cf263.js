import{g as ne,r as x,j as f,c as ae}from"./index-81f15401.js";import{m as E,l as re,a as se}from"./index-24ba74c6.js";const oe=[{name:"taiwan-z8",description:"Compare the appearance of highways",tags:["highway","cjk","tw"],center:[121.333,24.32],zoom:8},{name:"taiwan-z16-buildings",description:"Compare the appearance of buildings",tags:["building","cjk","tw"],center:[121.4818,25.0271],zoom:16},{name:"world",description:"Country labels",tags:[],center:[121,25],zoom:4},{name:"world2",description:"Country labels",tags:[],center:[0,0],zoom:2},{name:"zurich-bridges",description:"Pedestrian bridge tagged as area",tags:["bridge","ch"],center:[8.54252,47.376925],zoom:17},{name:"brazil-boundaries",description:"admin boundaries other than Brasilia should be visible at zoom 6",tags:["boundaries"],center:[-49.092,-15.092],zoom:6},{name:"kenya-boundaries",description:"admin boundaries level 5 around Nairobi should not appear broken",tags:["boundaries"],center:[37.382,-1.592],zoom:7},{name:"colombia-rivers",description:"water features west of Bogota should not be broken",tags:["water"],center:[-74.422,4.62],zoom:7.8},{name:"river-thames",description:"River Thames should not have pieces missing",tags:["water"],center:[-.3,51.4],zoom:8.9},{name:"landuse-urban-green",description:"show village_green, allotments, playgrounds",center:[7.3217,51.50406],tags:[],zoom:15}];var le=ce;const ie={threshold:.1,includeAA:!1,alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffColorAlt:null,diffMask:!1};function ce(e,t,n,a,s,r){if(!L(e)||!L(t)||n&&!L(n))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(e.length!==t.length||n&&n.length!==e.length)throw new Error("Image sizes do not match.");if(e.length!==a*s*4)throw new Error("Image data size does not match width/height.");r=Object.assign({},ie,r);const l=a*s,d=new Uint32Array(e.buffer,e.byteOffset,l),m=new Uint32Array(t.buffer,t.byteOffset,l);let i=!0;for(let o=0;o<l;o++)if(d[o]!==m[o]){i=!1;break}if(i){if(n&&!r.diffMask)for(let o=0;o<l;o++)Y(e,4*o,r.alpha,n);return 0}const h=35215*r.threshold*r.threshold;let c=0;for(let o=0;o<s;o++)for(let u=0;u<a;u++){const p=(o*a+u)*4,b=W(e,t,p,p);Math.abs(b)>h?!r.includeAA&&(F(e,u,o,a,s,t)||F(t,u,o,a,s,e))?n&&!r.diffMask&&U(n,p,...r.aaColor):(n&&U(n,p,...b<0&&r.diffColorAlt||r.diffColor),c++):n&&(r.diffMask||Y(e,p,r.alpha,n))}return c}function L(e){return ArrayBuffer.isView(e)&&e.constructor.BYTES_PER_ELEMENT===1}function F(e,t,n,a,s,r){const l=Math.max(t-1,0),d=Math.max(n-1,0),m=Math.min(t+1,a-1),i=Math.min(n+1,s-1),h=(n*a+t)*4;let c=t===l||t===m||n===d||n===i?1:0,o=0,u=0,p,b,v,w;for(let y=l;y<=m;y++)for(let R=d;R<=i;R++){if(y===t&&R===n)continue;const j=W(e,e,h,(R*a+y)*4,!0);if(j===0){if(c++,c>2)return!1}else j<o?(o=j,p=y,b=R):j>u&&(u=j,v=y,w=R)}return o===0||u===0?!1:T(e,p,b,a,s)&&T(r,p,b,a,s)||T(e,v,w,a,s)&&T(r,v,w,a,s)}function T(e,t,n,a,s){const r=Math.max(t-1,0),l=Math.max(n-1,0),d=Math.min(t+1,a-1),m=Math.min(n+1,s-1),i=(n*a+t)*4;let h=t===r||t===d||n===l||n===m?1:0;for(let c=r;c<=d;c++)for(let o=l;o<=m;o++){if(c===t&&o===n)continue;const u=(o*a+c)*4;if(e[i]===e[u]&&e[i+1]===e[u+1]&&e[i+2]===e[u+2]&&e[i+3]===e[u+3]&&h++,h>2)return!0}return!1}function W(e,t,n,a,s){let r=e[n+0],l=e[n+1],d=e[n+2],m=e[n+3],i=t[a+0],h=t[a+1],c=t[a+2],o=t[a+3];if(m===o&&r===i&&l===h&&d===c)return 0;m<255&&(m/=255,r=C(r,m),l=C(l,m),d=C(d,m)),o<255&&(o/=255,i=C(i,o),h=C(h,o),c=C(c,o));const u=S(r,l,d),p=S(i,h,c),b=u-p;if(s)return b;const v=$(r,l,d)-$(i,h,c),w=V(r,l,d)-V(i,h,c),y=.5053*b*b+.299*v*v+.1957*w*w;return u>p?-y:y}function S(e,t,n){return e*.29889531+t*.58662247+n*.11448223}function $(e,t,n){return e*.59597799-t*.2741761-n*.32180189}function V(e,t,n){return e*.21147017-t*.52261711+n*.31114694}function C(e,t){return 255+(e-255)*t}function U(e,t,n,a,s){e[t+0]=n,e[t+1]=a,e[t+2]=s,e[t+3]=255}function Y(e,t,n,a){const s=e[t+0],r=e[t+1],l=e[t+2],d=C(S(s,r,l),n*e[t+3]/255);U(a,t,d,d,d)}const fe=ne(le),X=(e,t)=>{const n=new Image,a=new Promise(s=>{n.onload=()=>{e.drawImage(n,0,0),s()}});return n.src=t,a},G=(e,t,n)=>new Promise(a=>{e.on("idle",()=>{const s=e.getCanvas();a(s.toDataURL())}),e.jumpTo({center:t,zoom:n})}),Q=(e,t,n,a,s)=>new E.Map({container:e,interactive:!1,style:{version:8,center:n,zoom:a,glyphs:"https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",sources:{protomaps:{type:"vector",url:`pmtiles://${t}`,attribution:""}},layers:s}}),z=new URLSearchParams(location.search),g=500*window.devicePixelRatio,de=async(e,t)=>{const[n,a]=await Promise.all([G(e.leftMap,t.center,t.zoom),G(e.rightMap,t.center,t.zoom)]);await X(e.leftCtx,n),await X(e.rightCtx,a);const s=e.diffCtx.createImageData(g,g),r=fe(e.leftCtx.getImageData(0,0,g,g).data,e.rightCtx.getImageData(0,0,g,g).data,s.data,g,g,{threshold:.1});return e.diffCtx.putImageData(s,0,0),{pixelsDifferent:r,leftData:n,rightData:a,diffData:e.diffCanvas.toDataURL()}},H=e=>{const t=new URLSearchParams(z);return t.delete("name"),t.delete("tag"),e.name&&t.set("name",e.name),e.tag&&t.set("tag",e.tag),`/visualtests/?${t.toString()}`},J=async e=>await(await fetch(`https://unpkg.com/protomaps-themes-base@${e}/dist/layers/light.json`)).json(),ue=async()=>(await(await fetch("https://registry.npmjs.org/protomaps-themes-base",{headers:{Accept:"application/vnd.npm.install-v1+json"}})).json())["dist-tags"].latest;function me(e){const t=x.useRef(null),n=x.useRef(null),a=x.useRef(null);x.useEffect(()=>{if(!t.current||!n.current||!a.current){console.error("DOM element not initialized");return}t.current.src=e.result.rendered.leftData,n.current.src=e.result.rendered.rightData,a.current.src=e.result.rendered.diffData},[e.result]);const s=e.result.example;return f.jsxs("div",{className:"example",children:[f.jsxs("div",{children:[f.jsx("img",{alt:"left",ref:t}),f.jsx("img",{alt:"right",ref:n}),f.jsx("img",{alt:"diff",ref:a})]}),f.jsx("a",{href:H({name:s.name}),children:s.name}),f.jsx("span",{children:s.description}),s.tags.map(r=>f.jsx("a",{href:H({tag:r}),children:r},r))]})}function he(){const e=x.useRef(null),t=x.useRef(null),n=x.useRef(null),a=x.useRef(null),s=x.useRef(null),r=x.useRef(null),l=x.useRef(null),[d,m]=x.useState([]),[i,h]=x.useState(["-","-","-","-"]);return x.useEffect(()=>((async()=>{E.getRTLTextPluginStatus()==="unavailable"&&E.setRTLTextPlugin("https://unpkg.com/@mapbox/mapbox-gl-rtl-text@0.2.3/mapbox-gl-rtl-text.min.js",!1);const o=new se;E.addProtocol("pmtiles",o.tile);const u=await(await fetch("https://build-metadata.protomaps.dev/builds.json")).json(),p=`https://build.protomaps.com/${u[u.length-1].key}`,b=z.get("leftTiles")||p,v=z.get("rightTiles")||p,w=z.get("leftStyle")||await ue(),y=z.get("rightStyle"),R=await J(w),j=y?await J(y):re("protomaps","light");h([b,v,w||"npm@latest",y||"local/main"]);const _=z.get("name"),q=z.get("tag");let M=oe;_!==null?M=M.filter(D=>D.name===_):q!==null&&(M=M.filter(D=>D.tags.indexOf(q)>=0));const P=M[0];if(!e.current||!t.current||!s.current||!r.current||!l.current){console.error("Page failed to initialize");return}n.current=Q(e.current,b,P.center,P.zoom,R),a.current=Q(t.current,v,P.center,P.zoom,j);const k=s.current;k.width=g,k.height=g;const I=r.current;I.width=g,I.height=g;const A=l.current;A.width=g,A.height=g;const B=k.getContext("2d",{willReadFrequently:!0}),N=I.getContext("2d",{willReadFrequently:!0}),O=A.getContext("2d",{willReadFrequently:!0});if(!B||!N||!O){console.error("Canvas failed to initialize");return}const Z={leftMap:n.current,rightMap:a.current,leftCtx:B,rightCtx:N,diffCtx:O,diffCanvas:A};for(const D of M){const ee=await de(Z,D);m(te=>[...te,{example:D,rendered:ee}])}})(),()=>{E.removeProtocol("pmtiles"),n.current&&n.current.remove(),a.current&&a.current.remove()}),[]),f.jsxs("div",{className:"visual-tests",children:[f.jsxs("div",{style:{position:"absolute",opacity:0,zIndex:-1},children:[f.jsx("div",{ref:e,className:"map"}),f.jsx("div",{ref:t,className:"map"}),f.jsx("canvas",{ref:s}),f.jsx("canvas",{ref:r}),f.jsx("canvas",{ref:l})]}),f.jsxs("div",{style:{width:"500px",display:"inline-block"},children:[i[0],f.jsx("br",{}),i[2]]}),f.jsxs("div",{style:{width:"500px",display:"inline-block"},children:[i[1],f.jsx("br",{}),i[3]]}),d.map(c=>f.jsx(me,{result:c},c.example.name))]})}const K=document.getElementById("root");K&&ae.createRoot(K).render(f.jsx(he,{}));
